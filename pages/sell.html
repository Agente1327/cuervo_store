<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cuervo Store — Vender Producto</title>
  <link rel="stylesheet" href="../css/globals.css"/>
  <link rel="stylesheet" href="../css/layout.css"/>
  <style>
    .sell-grid { display:grid; grid-template-columns:1fr 360px; gap:32px; }
    @media(max-width:900px){ .sell-grid{grid-template-columns:1fr;} }
    .image-upload-zone { border:2px dashed var(--border); padding:40px; text-align:center; cursor:pointer; transition:all .3s; position:relative; clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,12px 100%,0 calc(100% - 12px)); }
    .image-upload-zone:hover, .image-upload-zone.drag-over { border-color:var(--green); background:var(--green-dim); }
    .image-upload-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; }
    .img-preview-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:12px; }
    .img-preview { position:relative; aspect-ratio:1; }
    .img-preview img { width:100%; height:100%; object-fit:cover; border:1px solid var(--border); }
    .img-preview .remove-img { position:absolute; top:2px; right:2px; width:20px; height:20px; background:var(--danger); color:white; border:none; cursor:pointer; font-size:.7rem; display:flex; align-items:center; justify-content:center; }
    .preview-card { background:var(--bg2); border:1px solid var(--border); padding:24px; clip-path:var(--clip-card); position:sticky; top:80px; }
    .char-count { font-family:var(--font-mono); font-size:.6rem; color:var(--gray); text-align:right; margin-top:4px; }
    .seller-request-box { background:rgba(255,170,0,.06); border:1px solid var(--warn); padding:20px; clip-path:var(--clip-card); margin-bottom:24px; }
  </style>
</head>
<body>
<div id="crow-cursor"><svg viewBox="0 0 64 64" fill="none"><g><ellipse cx="30" cy="38" rx="14" ry="10" fill="#00ff88"/><polygon points="16,38 6,48 14,37 6,35" fill="#00ff88"/><ellipse cx="24" cy="32" rx="10" ry="5" transform="rotate(-20 24 32)" fill="#00cc6a"/><ellipse cx="36" cy="32" rx="10" ry="5" transform="rotate(20 36 32)" fill="#00cc6a"/><circle cx="42" cy="28" r="8" fill="#00ff88"/><circle cx="44" cy="26" r="2.5" fill="#030d0a"/><circle cx="44.8" cy="25.2" r=".8" fill="#fff"/><polygon points="49,27 56,24 50,30" fill="#00cc6a"/><ellipse id="cw-wing" cx="24" cy="30" rx="11" ry="4" transform="rotate(-30 24 30)" fill="#00ff8866"/></g></svg></div>
<div id="cursor-ring"></div>
<canvas id="bg-canvas"></canvas>
<div class="grid-overlay"></div><div class="scanlines"></div>
<div class="corner corner-tl"></div><div class="corner corner-tr"></div>
<div class="corner corner-bl"></div><div class="corner corner-br"></div>
<div id="neo-toast"></div>
<div id="main-nav"></div>

<main class="cs-main">
  <div class="cs-container">
    <div class="page-header">
      <h1>VENDER PRODUCTO</h1>
      <p>// publica tu producto y empieza a vender //</p>
    </div>
    <div id="main-content"></div>
  </div>
</main>

<script src="../js/app.js"></script>
<script>
  let uploadedImages = [];

  document.addEventListener('DOMContentLoaded', () => {
    Auth.init();
    if (!Auth.requireAuth()) return;
    renderNav('sell');
    renderSellPage();
  });

  function renderSellPage() {
    const user = Auth.current;
    const isSeller = Auth.isSeller();
    const content = document.getElementById('main-content');

    if (!isSeller) {
      content.innerHTML = `
        <div class="seller-request-box" style="max-width:560px;margin:0 auto;">
          <h3 style="font-family:var(--font-display);font-size:.9rem;letter-spacing:3px;color:var(--warn);margin-bottom:12px;">⚠ CUENTA DE VENDEDOR REQUERIDA</h3>
          <p style="font-family:var(--font-mono);font-size:.75rem;color:var(--gray);line-height:1.8;margin-bottom:16px;">
            Para publicar productos necesitas una cuenta de vendedor. 
            Envía tu solicitud y el equipo de Cuervo Store la revisará en 24-48 horas.
          </p>
          <div class="form-group">
            <label class="neo-label">¿Por qué quieres vender en Cuervo Store?</label>
            <textarea id="seller-reason" class="neo-input" rows="4" placeholder="Cuéntanos qué tipo de productos vendes y tu experiencia..."></textarea>
          </div>
          <button class="neo-btn full-width" onclick="requestSeller()"><span>SOLICITAR CUENTA DE VENDEDOR</span></button>
          <p style="font-family:var(--font-mono);font-size:.6rem;color:var(--gray);text-align:center;margin-top:12px;">
            Tu solicitud será revisada por Mr.Candy
          </p>
        </div>
      `;
      return;
    }

    // My products section
    const myProducts = Products.getBySeller(user.id);
    content.innerHTML = `
      <!-- My products list -->
      <div style="margin-bottom:40px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 class="cs-section-title" style="margin:0;">⬡ MIS PRODUCTOS (${myProducts.length})</h2>
        </div>
        ${myProducts.length === 0 ? `<p style="font-family:var(--font-mono);font-size:.75rem;color:var(--gray);">Aún no tienes productos publicados.</p>` : `
          <div style="overflow-x:auto;">
            <table class="neo-table">
              <thead><tr><th>PRODUCTO</th><th>PRECIO</th><th>STOCK</th><th>STATUS</th><th>VENDIDOS</th><th>ACCIONES</th></tr></thead>
              <tbody>
                ${myProducts.map(p => `
                  <tr>
                    <td>${p.title}</td>
                    <td>${formatPrice(p.price)}</td>
                    <td>${p.stock}</td>
                    <td><span class="neo-badge ${p.status==='approved'?'':'warn'}">${p.status.toUpperCase()}</span></td>
                    <td>${p.sold}</td>
                    <td style="display:flex;gap:8px;">
                      <button class="neo-btn" style="padding:6px 12px;font-size:.55rem;" onclick="editProduct('${p.id}')"><span>EDITAR</span></button>
                      <button class="neo-btn danger" style="padding:6px 12px;font-size:.55rem;" onclick="deleteProduct('${p.id}')"><span>✕</span></button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>

      <!-- Upload new product -->
      <div class="sell-grid">
        <div>
          <h2 class="cs-section-title">⬡ PUBLICAR NUEVO PRODUCTO</h2>
          <form id="sell-form">
            <div class="form-group">
              <label class="neo-label">▸ Título del producto *</label>
              <input id="p-title" class="neo-input" type="text" maxlength="100" placeholder="Ej: Arduino Mega 2560 + Kit de sensores" oninput="updatePreview();updateChar('p-title','title-chars',100)"/>
              <div class="char-count" id="title-chars">0/100</div>
            </div>
            <div class="form-group">
              <label class="neo-label">▸ Descripción detallada *</label>
              <textarea id="p-desc" class="neo-input" rows="5" maxlength="1000" placeholder="Describe tu producto con detalle: características, estado, incluye..." oninput="updatePreview();updateChar('p-desc','desc-chars',1000)"></textarea>
              <div class="char-count" id="desc-chars">0/1000</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div class="form-group">
                <label class="neo-label">▸ Precio (MXN) *</label>
                <input id="p-price" class="neo-input" type="number" min="1" placeholder="0.00" oninput="updatePreview()"/>
              </div>
              <div class="form-group">
                <label class="neo-label">▸ Stock disponible *</label>
                <input id="p-stock" class="neo-input" type="number" min="1" value="1"/>
              </div>
            </div>
            <div class="form-group">
              <label class="neo-label">▸ Categoría *</label>
              <select id="p-category" class="neo-input" style="background:var(--bg2);" onchange="updatePreview()">
                <option value="">-- Selecciona --</option>
                <option value="electronica">Electrónica</option>
                <option value="salud">Salud & Médico</option>
                <option value="libros">Libros & Cursos</option>
                <option value="ropa">Ropa & Uniformes</option>
                <option value="seguridad">Seguridad Industrial</option>
                <option value="herramientas">Herramientas</option>
                <option value="otros">Otros</option>
              </select>
            </div>
            <!-- Image upload -->
            <div class="form-group">
              <label class="neo-label">▸ Fotos del producto (máx. 6)</label>
              <div class="image-upload-zone" id="drop-zone" ondragover="dragOver(event)" ondragleave="dragLeave()" ondrop="dropImg(event)">
                <input type="file" id="img-input" accept="image/*" multiple onchange="handleImages(this)"/>
                <div style="font-size:2rem;margin-bottom:8px;color:var(--green);opacity:.5;">⬡</div>
                <div style="font-family:var(--font-mono);font-size:.7rem;color:var(--gray);letter-spacing:2px;">ARRASTRA O HAZ CLIC PARA SUBIR</div>
                <div style="font-family:var(--font-mono);font-size:.6rem;color:var(--gray);margin-top:4px;">JPG, PNG hasta 5MB c/u</div>
              </div>
              <div class="img-preview-grid" id="img-previews"></div>
            </div>
            <button type="submit" class="neo-btn full-width"><span>⬡ PUBLICAR PRODUCTO</span></button>
          </form>
        </div>
        <!-- Preview -->
        <div>
          <h2 class="cs-section-title">⬡ VISTA PREVIA</h2>
          <div class="preview-card">
            <div id="preview-img" style="width:100%;height:180px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:3rem;opacity:.2;margin-bottom:12px;">⬡</div>
            <div class="product-tag" id="preview-cat">CATEGORÍA</div>
            <div class="product-title" id="preview-title" style="margin:8px 0;">Título del producto</div>
            <div class="product-price" id="preview-price">$0.00</div>
            <div class="product-seller" style="margin-top:4px;">por ${Auth.current.name}</div>
          </div>
        </div>
      </div>
    `;

    document.getElementById('sell-form').addEventListener('submit', submitProduct);
  }

  function updatePreview() {
    document.getElementById('preview-title').textContent = document.getElementById('p-title').value || 'Título del producto';
    const price = parseFloat(document.getElementById('p-price').value) || 0;
    document.getElementById('preview-price').textContent = formatPrice(price);
    document.getElementById('preview-cat').textContent = document.getElementById('p-category').value || 'CATEGORÍA';
  }

  function updateChar(inputId, countId, max) {
    const len = document.getElementById(inputId).value.length;
    document.getElementById(countId).textContent = `${len}/${max}`;
  }

  function dragOver(e) { e.preventDefault(); document.getElementById('drop-zone').classList.add('drag-over'); }
  function dragLeave() { document.getElementById('drop-zone').classList.remove('drag-over'); }
  function dropImg(e) { e.preventDefault(); dragLeave(); handleImageFiles(e.dataTransfer.files); }

  function handleImages(inp) { handleImageFiles(inp.files); }

  function handleImageFiles(files) {
    const remaining = 6 - uploadedImages.length;
    Array.from(files).slice(0, remaining).forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = e => {
        uploadedImages.push(e.target.result);
        renderImagePreviews();
        if (uploadedImages.length === 1) {
          document.getElementById('preview-img').innerHTML = `<img src="${uploadedImages[0]}" style="width:100%;height:180px;object-fit:cover;"/>`;
        }
      };
      reader.readAsDataURL(file);
    });
  }

  function renderImagePreviews() {
    const grid = document.getElementById('img-previews');
    grid.innerHTML = uploadedImages.map((img, i) => `
      <div class="img-preview">
        <img src="${img}"/>
        <button class="remove-img" onclick="removeImg(${i})">✕</button>
      </div>
    `).join('');
  }

  function removeImg(i) { uploadedImages.splice(i, 1); renderImagePreviews(); }

  function submitProduct(e) {
    e.preventDefault();
    const title    = document.getElementById('p-title').value.trim();
    const desc     = document.getElementById('p-desc').value.trim();
    const price    = document.getElementById('p-price').value;
    const stock    = document.getElementById('p-stock').value;
    const category = document.getElementById('p-category').value;
    if (!title || !desc || !price || !category) { Toast.warn('Completa todos los campos obligatorios'); return; }
    if (parseFloat(price) <= 0) { Toast.error('El precio debe ser mayor a 0'); return; }
    const res = Products.add({ sellerId:Auth.current.id, sellerName:Auth.current.name, title, desc, price, stock, category, images:uploadedImages });
    if (res.ok) {
      Toast.success('Producto enviado para revisión. Será aprobado en breve.');
      uploadedImages = [];
      // Auto-approve for demo
      setTimeout(() => { Products.update(res.product.id, {status:'approved'}); }, 500);
      setTimeout(() => renderSellPage(), 1200);
    } else { Toast.error('Error al publicar. Intenta de nuevo.'); }
  }

  function deleteProduct(id) {
    if (!confirm('¿Eliminar este producto?')) return;
    Products.delete(id);
    Toast.success('Producto eliminado');
    renderSellPage();
  }

  function editProduct(id) { Toast.info('Editor avanzado próximamente'); }

  function requestSeller() {
    const reason = document.getElementById('seller-reason').value.trim();
    if (!reason) { Toast.warn('Explica por qué quieres vender'); return; }
    const users = DB.getUsers();
    const idx   = users.findIndex(u => u.id === Auth.current.id);
    if (idx > -1) { users[idx].sellerRequested = true; users[idx].sellerReason = reason; DB.saveUsers(users); }
    Toast.success('Solicitud enviada. El equipo de Mr.Candy la revisará pronto.');
    // Auto-approve for demo
    setTimeout(() => {
      const us = DB.getUsers();
      const i  = us.findIndex(u => u.id === Auth.current.id);
      if (i > -1) { us[i].role = 'seller'; DB.saveUsers(us); Auth.updateProfile({role:'seller'}); renderSellPage(); }
    }, 1500);
  }
</script>
</body>
</html>
