<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cuervo Store ‚Äî Producto</title>
  <link rel="stylesheet" href="../css/globals.css"/>
  <link rel="stylesheet" href="../css/layout.css"/>
  <style>
    .product-images { display:grid; grid-template-columns:80px 1fr; gap:12px; }
    .thumb-list { display:flex; flex-direction:column; gap:8px; }
    .thumb { width:80px; height:80px; object-fit:cover; border:1px solid var(--border); cursor:pointer; transition:border-color .2s; }
    .thumb.active, .thumb:hover { border-color:var(--green); box-shadow:0 0 8px var(--green-glow); }
    .main-img { width:100%; aspect-ratio:1; object-fit:cover; border:1px solid var(--border); background:var(--bg3); display:flex; align-items:center; justify-content:center; }
    .product-detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:40px; margin-top:32px; }
    @media(max-width:768px) { .product-detail-grid{ grid-template-columns:1fr; } .product-images{ grid-template-columns:1fr; } .thumb-list{ flex-direction:row; } }
    .qty-control { display:flex; align-items:center; gap:0; }
    .qty-btn { width:36px; height:36px; background:var(--bg2); border:1px solid var(--border); color:var(--green); font-size:1.1rem; cursor:pointer; transition:all .2s; }
    .qty-btn:hover { border-color:var(--green); background:var(--green-dim); }
    .qty-input { width:60px; height:36px; text-align:center; background:var(--bg2); border:1px solid var(--border); border-left:none; border-right:none; color:var(--white); font-family:var(--font-mono); font-size:.9rem; }
    .review-card { background:var(--bg2); border:1px solid var(--border); padding:20px; margin-bottom:12px; clip-path:var(--clip-card); }
    .seller-card { background:var(--bg2); border:1px solid var(--border); padding:24px; clip-path:var(--clip-card); margin-top:24px; }
  </style>
</head>
<body>
<div id="crow-cursor"><svg viewBox="0 0 64 64" fill="none"><g><ellipse cx="30" cy="38" rx="14" ry="10" fill="#00ff88"/><polygon points="16,38 6,48 14,37 6,35" fill="#00ff88"/><ellipse cx="24" cy="32" rx="10" ry="5" transform="rotate(-20 24 32)" fill="#00cc6a"/><ellipse cx="36" cy="32" rx="10" ry="5" transform="rotate(20 36 32)" fill="#00cc6a"/><circle cx="42" cy="28" r="8" fill="#00ff88"/><circle cx="44" cy="26" r="2.5" fill="#030d0a"/><circle cx="44.8" cy="25.2" r=".8" fill="#fff"/><polygon points="49,27 56,24 50,30" fill="#00cc6a"/><ellipse id="cw-wing" cx="24" cy="30" rx="11" ry="4" transform="rotate(-30 24 30)" fill="#00ff8866"/></g></svg></div>
<div id="cursor-ring"></div>
<canvas id="bg-canvas"></canvas>
<div class="grid-overlay"></div><div class="scanlines"></div>
<div class="corner corner-tl"></div><div class="corner corner-tr"></div>
<div class="corner corner-bl"></div><div class="corner corner-br"></div>
<div id="neo-toast"></div>
<div id="main-nav"></div>

<main class="cs-main">
  <div class="cs-container">
    <!-- Breadcrumb -->
    <div style="font-family:var(--font-mono);font-size:.65rem;color:var(--gray);margin-bottom:24px;letter-spacing:2px;">
      <a href="../index.html" style="color:var(--green);">INICIO</a> / 
      <a href="catalog.html" style="color:var(--green);">CAT√ÅLOGO</a> / 
      <span id="breadcrumb-title">PRODUCTO</span>
    </div>

    <div class="product-detail-grid" id="product-detail">
      <div style="text-align:center;padding:80px;color:var(--gray);">Cargando...</div>
    </div>

    <!-- REVIEWS -->
    <section class="cs-section" style="margin-top:48px;border-top:1px solid var(--border);padding-top:40px;">
      <h2 class="cs-section-title">‚¨° RESE√ëAS</h2>
      <div id="reviews-section"></div>
    </section>

    <!-- RELATED PRODUCTS -->
    <section class="cs-section">
      <h2 class="cs-section-title">‚¨° PRODUCTOS RELACIONADOS</h2>
      <div id="related-grid" class="product-grid"></div>
    </section>
  </div>
</main>

<!-- Review Modal -->
<div class="neo-modal-overlay" id="review-modal">
  <div class="neo-modal" style="position:relative;">
    <button class="neo-modal-close" onclick="closeReviewModal()">‚úï</button>
    <h3 style="font-size:.9rem;letter-spacing:3px;margin-bottom:20px;">ESCRIBIR RESE√ëA</h3>
    <div style="margin-bottom:16px;">
      <label class="neo-label">TU CALIFICACI√ìN</label>
      <div class="stars" id="review-stars" style="font-size:1.8rem;gap:8px;margin-top:8px;"></div>
    </div>
    <div class="form-group">
      <label class="neo-label">COMENTARIO</label>
      <textarea id="review-comment" class="neo-input" rows="4" placeholder="Describe tu experiencia con este producto..."></textarea>
    </div>
    <button class="neo-btn full-width" onclick="submitReview()"><span>ENVIAR RESE√ëA</span></button>
  </div>
</div>

<script src="../js/app.js"></script>
<script>
  let currentProduct = null;
  let reviewStars = 5;
  let qty = 1;

  document.addEventListener('DOMContentLoaded', () => {
    renderNav('catalog');
    const id = new URLSearchParams(window.location.search).get('id');
    if (!id) { window.location.href = 'catalog.html'; return; }
    currentProduct = Products.getById(id);
    if (!currentProduct) { window.location.href = 'catalog.html'; return; }
    renderProduct(currentProduct);
    renderReviews(currentProduct);
    renderRelated(currentProduct);
  });

  function renderProduct(p) {
    document.title = `${p.title} ‚Äî Cuervo Store`;
    document.getElementById('breadcrumb-title').textContent = p.title.toUpperCase();
    const stars = '‚òÖ'.repeat(Math.round(p.rating)) + '‚òÜ'.repeat(5-Math.round(p.rating));
    const imgs = p.images && p.images.length > 0;
    document.getElementById('product-detail').innerHTML = `
      <!-- IMAGES -->
      <div>
        ${imgs ? `
          <div class="product-images">
            <div class="thumb-list">
              ${p.images.map((img,i) => `<img class="thumb ${i===0?'active':''}" src="${img}" onclick="selectImg(this,'${img}')"/>`).join('')}
            </div>
            <img class="main-img" id="main-product-img" src="${p.images[0]}"/>
          </div>
        ` : `
          <div class="main-img" style="min-height:400px;font-size:6rem;opacity:.1;display:flex;align-items:center;justify-content:center;">‚¨°</div>
        `}
      </div>
      <!-- INFO -->
      <div>
        <div class="neo-badge" style="margin-bottom:12px;">${p.category.toUpperCase()}</div>
        <h1 style="font-size:1.4rem;letter-spacing:3px;margin:8px 0;">${p.title}</h1>
        <div style="display:flex;align-items:center;gap:12px;margin:8px 0;">
          <span style="color:var(--warn);font-size:1.1rem;">${stars}</span>
          <span style="font-family:var(--font-mono);font-size:.7rem;color:var(--gray);">${p.rating} ¬∑ ${p.reviews.length} rese√±as ¬∑ ${p.sold} vendidos</span>
        </div>
        <div style="font-family:var(--font-display);font-size:2.2rem;font-weight:900;color:var(--green);text-shadow:0 0 15px var(--green-glow);margin:16px 0;">
          ${formatPrice(p.price)}
        </div>
        <div style="font-family:var(--font-mono);font-size:.75rem;color:var(--gray);line-height:1.8;margin-bottom:20px;">
          ${p.desc}
        </div>
        <div style="margin-bottom:20px;">
          <span class="neo-badge ${p.stock>5?'':'warn'}">STOCK: ${p.stock} disponibles</span>
        </div>
        <!-- QTY -->
        <div style="margin-bottom:20px;">
          <label class="neo-label">CANTIDAD</label>
          <div class="qty-control" style="margin-top:8px;">
            <button class="qty-btn" onclick="changeQty(-1)">‚àí</button>
            <input class="qty-input" id="qty-display" type="number" value="1" min="1" max="${p.stock}" onchange="qty=parseInt(this.value)||1"/>
            <button class="qty-btn" onclick="changeQty(1)">+</button>
          </div>
        </div>
        <!-- ACTIONS -->
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:24px;">
          <button class="neo-btn" style="flex:2;" onclick="addToCartNow()"><span>üõí AGREGAR AL CARRITO</span></button>
          <button class="neo-btn" style="flex:1;border-color:var(--warn);color:var(--warn);" onclick="buyNow()"><span>‚ö° COMPRAR YA</span></button>
        </div>
        <div style="background:var(--green-dim);border:1px solid var(--border);padding:14px;font-family:var(--font-mono);font-size:.65rem;color:var(--gray);line-height:1.8;">
          ‚ú¶ Pago seguro con tarjeta de cr√©dito/d√©bito<br/>
          ‚ú¶ Protecci√≥n al comprador incluida<br/>
          ‚ú¶ Confirma tu compra por correo
        </div>
      </div>
    `;
  }

  function selectImg(el, src) {
    document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('main-product-img').src = src;
  }

  function changeQty(d) {
    qty = Math.max(1, Math.min(currentProduct.stock, qty + d));
    document.getElementById('qty-display').value = qty;
  }

  function addToCartNow() {
    Cart.add(currentProduct, qty);
    Toast.success(`${currentProduct.title} (x${qty}) agregado al carrito`);
  }

  function buyNow() {
    if (!Auth.isLoggedIn()) { Toast.warn('Inicia sesi√≥n para comprar'); setTimeout(() => window.location.href = 'login.html', 1000); return; }
    Cart.add(currentProduct, qty);
    window.location.href = 'cart.html';
  }

  function renderReviews(p) {
    const sec = document.getElementById('reviews-section');
    const avgBar = p.reviews.length ? (p.reviews.reduce((s,r)=>s+r.stars,0)/p.reviews.length).toFixed(1) : 0;
    sec.innerHTML = `
      <div style="display:flex;align-items:center;gap:24px;margin-bottom:28px;flex-wrap:wrap;">
        <div style="text-align:center;">
          <div style="font-family:var(--font-display);font-size:3rem;font-weight:900;color:var(--green);text-shadow:0 0 10px var(--green-glow);">${avgBar}</div>
          <div style="color:var(--warn);font-size:1.2rem;">${'‚òÖ'.repeat(Math.round(avgBar))}${'‚òÜ'.repeat(5-Math.round(avgBar))}</div>
          <div style="font-family:var(--font-mono);font-size:.6rem;color:var(--gray);">${p.reviews.length} rese√±as</div>
        </div>
        <button class="neo-btn" onclick="openReviewModal()"><span>‚ú¶ ESCRIBIR RESE√ëA</span></button>
      </div>
      <div id="review-list">
        ${p.reviews.length === 0 ? `<div style="font-family:var(--font-mono);font-size:.75rem;color:var(--gray);text-align:center;padding:40px 0;">S√© el primero en rese√±ar este producto.</div>` :
          p.reviews.map(r => `
            <div class="review-card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-family:var(--font-mono);font-size:.75rem;color:var(--green);">${r.userName || 'Usuario'}</div>
                <div style="color:var(--warn);font-size:.9rem;">${'‚òÖ'.repeat(r.stars)}${'‚òÜ'.repeat(5-r.stars)}</div>
              </div>
              <p style="font-size:.85rem;color:rgba(240,255,248,.7);">${r.comment}</p>
              <div style="font-family:var(--font-mono);font-size:.6rem;color:var(--gray);margin-top:8px;">${new Date(r.createdAt).toLocaleDateString()}</div>
            </div>
          `).join('')
        }
      </div>
    `;
  }

  function renderRelated(p) {
    const related = Products.getApproved().filter(r => r.id !== p.id && r.category === p.category).slice(0,4);
    const grid = document.getElementById('related-grid');
    if (related.length === 0) { grid.innerHTML = `<p style="font-family:var(--font-mono);font-size:.75rem;color:var(--gray);">Sin productos relacionados.</p>`; return; }
    grid.innerHTML = related.map(r => `
      <div class="product-card" onclick="window.location.href='product.html?id=${r.id}'">
        <div class="product-card-img">${r.images&&r.images.length?`<img src="${r.images[0]}" style="width:100%;height:200px;object-fit:cover;"/>`:''}</div>
        <div class="product-card-body">
          <div class="product-title">${r.title}</div>
          <div class="product-price">${formatPrice(r.price)}</div>
        </div>
      </div>
    `).join('');
  }

  function openReviewModal() {
    if (!Auth.isLoggedIn()) { Toast.warn('Inicia sesi√≥n para rese√±ar'); return; }
    reviewStars = 5;
    renderReviewStars();
    document.getElementById('review-comment').value = '';
    document.getElementById('review-modal').classList.add('open');
  }
  function closeReviewModal() { document.getElementById('review-modal').classList.remove('open'); }

  function renderReviewStars() {
    const el = document.getElementById('review-stars');
    el.innerHTML = [1,2,3,4,5].map(n => `<span style="cursor:pointer;color:${n<=reviewStars?'var(--warn)':'var(--border)'};font-size:2rem;" onclick="setReviewStars(${n})">${n<=reviewStars?'‚òÖ':'‚òÜ'}</span>`).join('');
  }
  function setReviewStars(n) { reviewStars = n; renderReviewStars(); }

  function submitReview() {
    const comment = document.getElementById('review-comment').value.trim();
    if (!comment) { Toast.warn('Escribe un comentario'); return; }
    Products.addReview(currentProduct.id, { stars:reviewStars, comment, userName: Auth.current.name });
    currentProduct = Products.getById(currentProduct.id);
    renderReviews(currentProduct);
    closeReviewModal();
    Toast.success('Rese√±a enviada');
  }
</script>
</body>
</html>
